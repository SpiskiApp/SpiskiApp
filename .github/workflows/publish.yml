name: publish

on:
  release:
    types: [ published ]

jobs:

  publish:

    runs-on: ubuntu-latest

    env:
      DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
      DEPLOY_USERNAME: ${{ secrets.DEPLOY_USERNAME }}
      DEPLOY_REPO: ${{ secrets.DEPLOY_REPO }}

    steps:
      - uses: actions/checkout@v2
      - name: Build
        run: |

          echo "Login to docker hub"
          echo "$DEPLOY_TOKEN" | docker login --username "$DEPLOY_USERNAME" --password-stdin

          # $GITHUB_REF is in the form of 'refs/tags/<tag>'
          DEPLOY_TAG=$(echo "$GITHUB_REF" | awk -F "/" '{print($3)}')
          IMAGE_TAG=$DEPLOY_USERNAME/$DEPLOY_REPO:$DEPLOY_TAG

          cd app/
          echo "Building $IMAGE_TAG"
          docker build . -t $IMAGE_TAG -f Dockerfile.prod

          echo "Pushing to the docker hub"
          docker push $IMAGE_TAG

          echo "The image was successfully pushed"
